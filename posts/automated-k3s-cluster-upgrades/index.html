<!DOCTYPE html><html lang="en-US" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Bootstrapping a K3s Cluster and Configuring its Automated Upgrades" /><meta property="og:locale" content="en_US" /><meta name="description" content="This article focuses on how to setup and bootstrap the multi-node K3s cluster and how to configure automated upgrading of the K3s Kubernetes cluster. This covers both how to setup a multi-node K3s Kubernetes cluster and how to upgrade K3s automatically using the system upgrade controller." /><meta property="og:description" content="This article focuses on how to setup and bootstrap the multi-node K3s cluster and how to configure automated upgrading of the K3s Kubernetes cluster. This covers both how to setup a multi-node K3s Kubernetes cluster and how to upgrade K3s automatically using the system upgrade controller." /><link rel="canonical" href="https://zawzaw.blog/posts/automated-k3s-cluster-upgrades/" /><meta property="og:url" content="https://zawzaw.blog/posts/automated-k3s-cluster-upgrades/" /><meta property="og:site_name" content="Zaw Zaw" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-02-25T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Bootstrapping a K3s Cluster and Configuring its Automated Upgrades" /><meta name="twitter:site" content="@zawzaw_me" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-12-31T07:42:38+00:00","datePublished":"2024-02-25T00:00:00+00:00","description":"This article focuses on how to setup and bootstrap the multi-node K3s cluster and how to configure automated upgrading of the K3s Kubernetes cluster. This covers both how to setup a multi-node K3s Kubernetes cluster and how to upgrade K3s automatically using the system upgrade controller.","headline":"Bootstrapping a K3s Cluster and Configuring its Automated Upgrades","mainEntityOfPage":{"@type":"WebPage","@id":"https://zawzaw.blog/posts/automated-k3s-cluster-upgrades/"},"url":"https://zawzaw.blog/posts/automated-k3s-cluster-upgrades/"}</script><title> Bootstrapping a K3s Cluster and Configuring its Automated Upgrades | Zaw Zaw</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/images/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/images/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Zaw Zaw"><meta name="application-name" content="Zaw Zaw"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/images/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/images/favicons/favicon-16x16.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Zaw Zaw</a></div><div class="site-subtitle font-italic">ZAW's Library & Personal Blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/photography/" class="nav-link"> <i class="fa-fw fas fa-image ml-xl-3 mr-xl-3 unloaded"></i> <span>PHOTOGRAPHY</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fas fa-phone ml-xl-3 mr-xl-3 unloaded"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/zawzaww" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://x.com/zawzaw_me" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-x-twitter"></i> </a> <a href="https://www.linkedin.com/in/zawzaww" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.instagram.com/zawzaw.me" aria-label="instagram" target="_blank" rel="noopener"> <i class="fab fa-instagram"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['zawzthein','outlook.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Bootstrapping a K3s Cluster and Configuring its Automated Upgrades</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Bootstrapping a K3s Cluster and Configuring its Automated Upgrades</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Bootstrapping a K3s Cluster and Configuring its Automated Upgrades</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Zaw Zaw </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Feb 25, 2024, 12:00 AM +0000" prep="on" > Feb 25, 2024 <i class="unloaded">2024-02-25T00:00:00+00:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Dec 31, 2024, 3:42 PM +0800" prefix="Updated " > Dec 31, 2024 <i class="unloaded">2024-12-31T07:42:38+00:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1139 words">6 min</span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/featured-images/img_k3s_kubernetes.png" class="preview-img" alt="Preview Image"><p align="center"> <span class="caption" style="font-size: 14px; font-weight: 500; font-style: oblique;"> Combined official K3s and Kubernetes logo by Zaw Zaw </span></p><p>This article focuses on how to setup and bootstrap the multi-node K3s cluster and how to configure automated upgrading of the K3s Kubernetes cluster. This covers both how to setup a multi-node K3s Kubernetes cluster and how to upgrade K3s automatically using the system upgrade controller.</p><p>Usually, we manually download the K3s binary file from the GitHub release page, install and upgrade it in K3s Server and Agent Kubernetes nodes. Instead, we can manage and configure automated cluster upgrading for K3s using Rancherâ€™s <a href="https://github.com/rancher/system-upgrade-controller">system upgrade controller</a> and <strong>Plan</strong> CRD, Custom Resource Definition.</p><h2 id="objectives">Objectives</h2><ul><li>Setup a Multi-node K3s Kubernetes cluster.<li>Explore the System Upgrade Controller and how it works.<li>Install the System Upgrade Controller on Kubernetes.<li>Configure <code class="language-plaintext highlighter-rouge">Plan</code> CRD to automate K3s cluster upgrade.<li>Monitor K3s System Upgrade <code class="language-plaintext highlighter-rouge">Plan</code> configuration and job status.</ul><h2 id="setup-k3s-kubernetes-cluster">Setup K3s Kubernetes Cluster</h2><p>Firstly, we need to setup and bootstrap the K3s cluster with the installation script. Itâ€™s simple to set up a Server and an Agent. In this article, I will use AWS EC2 instances to setup the K3s cluster.</p><p>We have two AWS EC2 instances:</p><ul><li><em>k3s-dev-master (K3s Server)</em><li><em>k3s-dev-worker (K3s Agent)</em></ul><p>Official K3s Documentation: <a href="https://docs.k3s.io">https://docs.k3s.io</a></p><h3 id="k3s-server-controlplanemaster-node">K3s Server (ControlPlane/Master Node)</h3><p>On the <strong>k3s-dev-master</strong> instance, run the following installation script to bootstrap the K3s server, also known as Kubernetes ControlPlane/Master Node.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>curl <span class="nt">-sfL</span> https://get.k3s.io | sh <span class="nt">-s</span> - server <span class="se">\</span>
    <span class="nt">--write-kubeconfig-mode</span> 644 <span class="se">\</span>
    <span class="nt">--node-taint</span> <span class="s2">"CriticalAddonsOnly=true:NoExecute"</span>
</pre></table></code></div></div><p>If you want to make your K3s server as a ControlPlane/Master only, Make sure you add <code class="language-plaintext highlighter-rouge">CriticalAddonsOnly=true:NoExecute</code> Node taint when bootstrapping the K3s server.</p><p>Or, alternatively, you can also add Node taints with the <code class="language-plaintext highlighter-rouge">kubectl</code> command-line tool.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubectl taint node k3s-dev-master <span class="nv">CriticalAddonsOnly</span><span class="o">=</span><span class="nb">true</span>:NoExecute
<span class="nv">$ </span>kubectl taint node k3s-dev-master node-role.kubernetes.io/master<span class="o">=</span><span class="nb">true</span>:NoSchedule
<span class="nv">$ </span>kubectl taint node k3s-dev-master node-role.kubernetes.io/control-plane<span class="o">=</span><span class="nb">true</span>:NoSchedule
</pre></table></code></div></div><h3 id="k3s-agent-worker-node">K3s Agent (Worker Node)</h3><p>On the <strong>k3s-dev-worker</strong> instance, run the following installation script to bootstrap K3s Agent also known as Kubernetes Worker Node to join the ControlPlane/Master Node.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>curl <span class="nt">-sfL</span> https://get.k3s.io | sh <span class="nt">-s</span> - agent <span class="se">\</span>
    <span class="nt">--server</span> https://&lt;172.16.x.x&gt;:6443 <span class="se">\</span>
    <span class="nt">--token</span> K10d47c3a1abbbc24647fc37f9531ee6d9145d485408dc19f0bf4964c82beeaf175::server:91d5e063491d81783cab2bf1e728e4f1
</pre></table></code></div></div><p>Explanation:</p><ul><li><code class="language-plaintext highlighter-rouge">--server</code><ul><li><em>Set your K3s Serverâ€™s URL that includes IP address and port number.</em></ul><li><code class="language-plaintext highlighter-rouge">--token</code><ul><li><em>Set your K3s Serverâ€™s token. You can find that token in your K3s Serverâ€™s file path <code class="language-plaintext highlighter-rouge">/var/lib/rancher/k3s/server/node-token</code> or <code class="language-plaintext highlighter-rouge">/var/lib/rancher/k3s/server/token</code>.</em></ul></ul><p>To get K3s Serverâ€™s token, go to the K3s Server, <strong>k3s-dev-master</strong> instance and get the node token by running the <code class="language-plaintext highlighter-rouge">cat</code> command tool. The node token filepath is <code class="language-plaintext highlighter-rouge">/var/lib/rancher/k3s/server/node-token</code> (or) <code class="language-plaintext highlighter-rouge">/var/lib/rancher/k3s/server/token</code>.</p><p>For example,</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat</span> /var/lib/rancher/k3s/server/node-token
K10d47c3a1abbbc24647fc37f9531ee6d9145d485408dc19f0bf4964c82beeaf175::server:91d5e063491d81783cab2bf1e728e4f1
</pre></table></code></div></div><p>Add label to mark Kubernetes Worker Node as Worker role.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl label node k3s-dev-worker node-role.kubernetes.io/worker<span class="o">=</span><span class="nb">true</span>
</pre></table></code></div></div><p>Finally, we can get nodes with <code class="language-plaintext highlighter-rouge">kubectl</code> command line tool</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> wide

NAME                 STATUS   ROLES                  AGE   VERSION        INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION       CONTAINER-RUNTIME
k3s-dev-master       Ready    control-plane,master   8d    v1.28.6+k3s2   172.x.x.x        &lt;none&gt;        Ubuntu 22.04.3 LTS   5.15.0-94-generic    containerd://1.7.11-k3s2
k3s-dev-worker       Ready    worker                 8d    v1.28.6+k3s2   172.x.x.x        &lt;none&gt;        Ubuntu 22.04.3 LTS   5.15.0-94-generic    containerd://1.7.11-k3s2
</pre></table></code></div></div><h2 id="system-upgrade-controller">System Upgrade Controller</h2><p>Basically, System Upgrade Controller aims to provide a general-purpose, Kubernetes-native upgrade controller for Nodes. It introduces a new Custom Resource Definition <strong>Plan</strong> for defining all of your upgrade requirements and a controller that schedules upgrades based on the configured plans.</p><p>GitHub Repository: <a href="https://github.com/rancher/system-upgrade-controller">https://github.com/rancher/system-upgrade-controller</a></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/rancher/system-upgrade-controller/master/doc/architecture.png" alt="image" /> <em>System Upgrade Controller Architecture Photo by Rancher</em></p><p>Before we configure <code class="language-plaintext highlighter-rouge">Plan</code> CRD for automated upgrades for K3s Kubernetes cluster, make sure you install <em>system-upgrade-controller</em> on your cluster.</p><p>To install the <strong>system-upgrade-controller</strong> with kubectl,</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl apply <span class="nt">-f</span> https://github.com/rancher/system-upgrade-controller/releases/latest/download/system-upgrade-controller.yaml
</pre></table></code></div></div><p>This installs <em>system-upgrade-controller</em> Deployment and required ServiceAccount, ClusterRoleBinding and ConfigMap into <em>system-upgrade</em> namespace.</p><h2 id="configure-k3s-system-upgrade-plans">Configure K3s System Upgrade Plans</h2><p>For configuring automated K3s cluster upgrades, make sure you configure and deploy <em>Plan</em> configuration on your K3s Kubernetes Cluster. <em>Plan</em> basically defines how we plan for your next K3s upgrades. For example; K3s version, channel, cordon, concurrency and so on.</p><p>Create a Kubernetes API resource YAML file using <code class="language-plaintext highlighter-rouge">Plan</code> CRD named <code class="language-plaintext highlighter-rouge">plan-k3s-upgrade.yaml</code> like the following example configuration. YAML filename can be as you like.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">upgrade.cattle.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Plan</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">plan-k3s-server-upgrade</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">system-upgrade</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">concurrency</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">cordon</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">tolerations</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">effect</span><span class="pi">:</span> <span class="s">NoSchedule</span>
      <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
    <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">CriticalAddonsOnly</span>
      <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
    <span class="pi">-</span> <span class="na">effect</span><span class="pi">:</span> <span class="s">NoExecute</span>
      <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
    <span class="pi">-</span> <span class="na">effect</span><span class="pi">:</span> <span class="s">NoSchedule</span>
      <span class="na">key</span><span class="pi">:</span> <span class="s">node-role.kubernetes.io/controlplane</span>
      <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
    <span class="pi">-</span> <span class="na">effect</span><span class="pi">:</span> <span class="s">NoExecute</span>
      <span class="na">key</span><span class="pi">:</span> <span class="s">node-role.kubernetes.io/etcd</span>
      <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="na">matchExpressions</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">node-role.kubernetes.io/master</span>
        <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
        <span class="na">values</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">system-upgrade</span>
  <span class="na">upgrade</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">rancher/k3s-upgrade</span>
  <span class="c1"># channel: https://update.k3s.io/v1-release/channels/stable</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">v1.28.6+k3s2</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">upgrade.cattle.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Plan</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">plan-k3s-agent-upgrade</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">system-upgrade</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">concurrency</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">cordon</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="na">matchExpressions</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">node-role.kubernetes.io/worker</span>
        <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
        <span class="na">values</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">system-upgrade</span>
  <span class="na">upgrade</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">rancher/k3s-upgrade</span>
  <span class="c1"># channel: https://update.k3s.io/v1-release/channels/stable</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">v1.28.6+k3s2</span>
</pre></table></code></div></div><p>There are important things to understand configuring the K3s Plans</p><ul><li><code class="language-plaintext highlighter-rouge">spec.concurrency</code><ul><li>Set <em>concurrency</em> if you want to run System Upgrade jobs concurrently.</ul><li><code class="language-plaintext highlighter-rouge">spec.cordon</code><ul><li>Set <em>cordon</em> to true if you want to enable cordon also known as mark Node as unschedulable.</ul><li><code class="language-plaintext highlighter-rouge">spec.tolerations</code><ul><li>Set <em>tolerations</em> if your ControlPlane/Master Node has taints because <em>Plan</em> job needs to run in Master or K3s server node. Please, see <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration">https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration</a></ul><li><code class="language-plaintext highlighter-rouge">spec.nodeSelector</code><ul><li>Set <em>nodeSelector</em> with key/value Node labels. Make sure you set node selector correctly to run <em>Plan</em> jobs on both ControlPlane/Master and Worker nodes.</ul><li><code class="language-plaintext highlighter-rouge">spec.serviceAccountName</code><ul><li>Set <em>serviceAccountName</em>. Defaults to <em>system-upgrade</em> service account.</ul><li><code class="language-plaintext highlighter-rouge">spec.upgrade.image</code><ul><li>Set K3s upgrade image. Defaults to <code class="language-plaintext highlighter-rouge">rancher/k3s-upgrade</code> Container image.</ul><li><code class="language-plaintext highlighter-rouge">spec.channel</code><ul><li>Set K3s upgrade channel <a href="https://update.k3s.io/v1-release/channels/stable">https://update.k3s.io/v1-release/channels/stable</a>.</ul><li><code class="language-plaintext highlighter-rouge">spec.version</code><ul><li>Set specific K3s version to upgrade. For example, current latest stable version is v1.28.6+k3s2.</ul></ul><p>We can also set <code class="language-plaintext highlighter-rouge">spec.channel</code> to <code class="language-plaintext highlighter-rouge">stable</code> or <code class="language-plaintext highlighter-rouge">latest</code> to upgrade automatically K3s to current latest version based on you specified K3s upgrade channel.</p><p>Default K3s upgrade channel is <strong>stable</strong>.</p><p>For example; Stable Channel</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">upgrade.cattle.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Plan</span>
<span class="nn">...</span>
<span class="s">spec</span>
<span class="nn">...</span>
  <span class="na">channel</span><span class="pi">:</span> <span class="s">https://update.k3s.io/v1-release/channels/stable</span>
</pre></table></code></div></div><p>For example; Latest Channel</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">upgrade.cattle.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Plan</span>
<span class="nn">...</span>
<span class="s">spec</span>
<span class="nn">...</span>
  <span class="na">channel</span><span class="pi">:</span> <span class="s">https://update.k3s.io/v1-release/channels/latest</span>
</pre></table></code></div></div><p>Please, also note that System Upgrade Job automatically upgrades to current latest K3s version when available new version in <code class="language-plaintext highlighter-rouge">stable</code> or <code class="language-plaintext highlighter-rouge">latest</code> channel if you have not specified K3s version to upgrade. It depends on you specified channel.</p><p>After configure Plans for both K3s Server and Agent, deploy the <code class="language-plaintext highlighter-rouge">Plan</code> resources with kubectl.</p><p>Make sure you deploy <code class="language-plaintext highlighter-rouge">system-upgrade-controller</code> and <code class="language-plaintext highlighter-rouge">Plan</code> in same <code class="language-plaintext highlighter-rouge">system-upgrade</code> namesapce.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubect apply <span class="nt">-f</span> k3s-system-upgrade.yaml
</pre></table></code></div></div><p>Then, the controller will pick them up and begin to upgrade K3s to latest version based on K3s upgrade channel <code class="language-plaintext highlighter-rouge">stable</code> or <code class="language-plaintext highlighter-rouge">latest</code> if you have specified channel or specific K3s version in <code class="language-plaintext highlighter-rouge">Plan</code> resource.</p><h2 id="checking-k3s-system-upgrade-jobs">Checking K3s System Upgrade Jobs</h2><p>Finally, we can check and monitor the progress of an upgrade by viewing <code class="language-plaintext highlighter-rouge">Plan</code> and <code class="language-plaintext highlighter-rouge">Jobs</code> with kubectl command line tool.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubectl get plans <span class="nt">--namespace</span> system-upgrade <span class="nt">-o</span> yaml
<span class="nv">$ </span>kubectl get <span class="nb">jobs</span> <span class="nt">--namespace</span> system-upgrade
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/k3s/" class="post-tag no-text-decoration" >k3s</a> <a href="/tags/automate/" class="post-tag no-text-decoration" >automate</a> <a href="/tags/upgrade/" class="post-tag no-text-decoration" >upgrade</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Bootstrapping a K3s Cluster and Configuring its Automated Upgrades - Zaw Zaw&url=https://zawzaw.blog/posts/automated-k3s-cluster-upgrades/" data-toggle="tooltip" data-placement="top" title="X (Twitter)" target="_blank" rel="noopener" aria-label="X (Twitter)"> <i class="fa-fw fab fa-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Bootstrapping a K3s Cluster and Configuring its Automated Upgrades - Zaw Zaw&u=https://zawzaw.blog/posts/automated-k3s-cluster-upgrades/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://zawzaw.blog/posts/automated-k3s-cluster-upgrades/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2" style="font-size: large;">Table of Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Related Posts</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/write-k8s-helm-chart/"><div class="card-body"> <span class="timeago small" > Feb 14, 2022 <i class="unloaded">2022-02-14T00:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Building a Kubernetes Helm Chart from Scratch</h3><div class="text-muted small"><p> In this blog post, I will share about writing Kubernetes Helm chart, YAML-based Helm template language, Helm chart development tips and focus on how to write a simple Helm Chart step by step for an...</p></div></div></a></div><div class="card"> <a href="/posts/configure-k8s-auth-rbac/"><div class="card-body"> <span class="timeago small" > Dec 5, 2024 <i class="unloaded">2024-12-05T00:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configuring RBAC Role Bindings for a User on Kubernetes</h3><div class="text-muted small"><p> This article focuses on how to create a user and configure cluster roles and role bindings for that user using Kubernetes built-in RBAC authorization features. Basically, in Kubernetes, we can use ...</p></div></div></a></div><div class="card"> <a href="/posts/guide-k8s-persistent-storage/"><div class="card-body"> <span class="timeago small" > Jan 31 <i class="unloaded">2025-01-31T00:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>A Hands-on Practical Guide to K8s Persistent Storage</h3><div class="text-muted small"><p> In Kubernetes, we typically need to create and use Persistent Volumes for stateful applications such as database servers, cache store servers, and so on. In this article, I will share how storage p...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/polar-night-and-midnight-sun/" class="btn btn-outline-primary" prompt="Older"><p>Exploring the Polar Night and Midnight Sun (Polar Day)</p></a> <a href="/posts/explore-the-philippines/" class="btn btn-outline-primary" prompt="Newer"><p>Exploring the Philippines: My Travel Experience to Iloilo City</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> Â© 2025, <a href="https://github.com/zawzaww">Zaw Zaw</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) by the author.">Licensed under CC BY 4.0.</span></p></div><div class="footer-right"><p class="mb-0"> <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">CHIRPY Theme</a> &mdash; <a href="https://jekyllrb.com" target="_blank" rel="noopener"> Powered byJekyll</a></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/aosp/">aosp</a> <a class="post-tag" href="/tags/build/">build</a> <a class="post-tag" href="/tags/containerization/">containerization</a> <a class="post-tag" href="/tags/containers/">containers</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/asia/">asia</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://zawzaw.blog{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
